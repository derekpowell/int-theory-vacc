---
title: 'Vaccines: Many Beliefs Study 2: jobtalk'
author: "Derek Powell"
date: "November 16, 2018"
output: html_notebook
---

```{r, include = F}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r setup, include = F}
library(tidyverse)
library(psych)
# library(ggcorrplot)
library(lme4)
library(brms)
library(rms)
```


# model

```{r}
# detach("package:BiDAG", unload=TRUE)

library(tidyverse)
library(BiDAG)
# BiDAG depends on 'graph' package, source: http://www.bioconductor.org/packages/release/bioc/html/graph.html
# BiDAG depends on 'RBGL' package, source: https://bioconductor.org/packages/release/bioc/html/RBGL.html
library(bnlearn)
library(HydeNet)
library(gtools)

# source("cog-model-graph-tools.R")
source("../scripts/custom-structure-learning/cog-model-main.R", chdir = TRUE)
source("../scripts/gmod_tools.R")
source("../scripts/bnTheoryBlacklist.R")
source("../scripts/custom-structure-learning/cog-model-jags-tools.R")

# # customize BiDAG functions
# orig_DAGcorescore <- BiDAG:::DAGcorescore # save to switch back if desired
# orig_TableDAGscore.alias <- BiDAG:::TableDAGscore.alias # save to switch back if desired

source("../study1/vacc_import_data.R", chdir = TRUE)


ibm_palette <- c("#648fff", "#785ef0", "#dc267f", "#fe6100", "#ffb000")
```

# Set up data

Participants responses were scaled from a 1 to 7 rating scale onto the open interval (0,1). We scaled these responses as recommended by [cite beta regression paper]. After scaling, we interpret these responses as indicating participants' credence in each belief--that is, the marginal probability they assign to the state of affairs described by the scale.

```{r}
# rescale beta

rescale_beta <- function(x, lower, upper) {
  # rescales onto the open interval (0,1)
  # rescales over theoretical bounds of measurement, specified by "upper" and "lower"

  N <- length(x)
  res <- (x - lower) / (upper - lower)
  res <- (res * (N - 1) + .5) / N

  return(as.vector(res))
}

d_bn_scaled <- d_bn %>%
 mutate_all(function(x){rescale_beta(x,-3,3)})

## set the seed to make your partition reproductible
set.seed(123)
trainInd <- sample(seq_len(nrow(d_bn_scaled)), size = floor(nrow(d_bn_scaled)*.80))

train <- d_bn_scaled[trainInd, ]
test <- d_bn_scaled[-trainInd, ]
```


```{r}
map_dag <- readRDS("../local/map_dag_bn_theorybased.rds")
h <- readRDS("../local/map_dag_hydenet_theorybased.rds")
model_string <- readRDS("../local/map_dag_modelstring_theorybased.rds")
test_analyze <- readRDS("../local/s1_model_predictions.rds")


```


# job talk plots

November 16, 2018

## predicted vs observed across scales

```{r}
# library(ggthemes)

recode_nodes <- function(x){
  recode(x,
         "diseaseRare" = "Disease Rarity",
         "diseaseSevere" = "Disease Severity",
         "hb" = "Holistic Balance",
         "infantImmLimCap" = "IIS: Limited\nCapacity",
         "infantImmWeak" = "IIS: Weakness",
         "medSkept" = "Medical\nSkepticism",
         "nat" = "Naturalism",
         "overpar" = "Parental\nProtectiveness",
         "parentExpert" = "Parental\nExpertise",
         "vaccDanger" = "Vaccine\nDanger",
         "vaccEff" = "Vaccine\nEffectiveness",
         "vaccIntent" = "Vaccination\nIntentions",
         "vaccStrain" = "IIS: Vaccines\nStrain",
         "vaccTox" = "Vaccines\nToxicity")}

predObsCor <- cor(test_analyze$value,test_analyze$predValue)

corrDF <- test_analyze %>%
  mutate(varName = recode_nodes(varName)) %>%
  group_by(varName) %>%
  summarise(cor = cor(value,predValue)) %>%
  mutate(cor = format(round(cor,2),nsmall=2))

(
plt.valid <- test_analyze %>%
  mutate(varName = recode_nodes(varName)) %>%
  ggplot(aes(x=predValue, y=value)) + 
  geom_abline(slope=1, intercept=0, linetype="dashed", alpha=.33) +
  geom_point(shape=1, size=.5, color=ibm_palette[3]) + 
  geom_text(data=corrDF, aes(label=paste("r =", cor)),
            x=-Inf, y=Inf, hjust=-0.12, vjust=1.4,
            size = 10*.352777778,
            color="grey25") +
  # geom_smooth(method="lm") +
  coord_fixed() + 
  facet_wrap(~varName, nrow=2) + 
  scale_x_continuous("Predicted values", limits = c(0, 1)) +
  scale_y_continuous("Observed values", limits = c(0, 1)) +
  theme_bw(base_size = 10) +
  theme(strip.background = element_rect(fill="grey90"), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
)

# ggsave(plot = plt.valid, filename = "../local/s1_predobs_plot.png", width=8.5, height=4)
```

## network structure (beautified)

```{r}
# do network structure plotting here ...
library(DiagrammeR)

custom_plot.HydeNetwork <- function(x, 
                             customNodes = NULL,
                             customEdges = NULL,
                             ..., 
                             removeDeterm = FALSE,
                             useHydeDefaults = TRUE)
{
  if (removeDeterm) x <- plot_nondeterm_only(x)
  
  node_df <- 
    DiagrammeR::create_node_df(n = length(x[["nodes"]]),
                               label = x[["nodes"]])
  # 
  # node_df <- data.frame(nodes = x[["nodes"]],
  #                       stringsAsFactors = FALSE)
  if (useHydeDefaults) node_df <- HydeNet:::mergeDefaultPlotOpts(x, node_df)
  
  if (!is.null(customNodes)) node_df <- HydeNet::mergeCustomNodes(node_df, customNodes)
  
  edge_table <- do.call("rbind", 
                        mapply(FUN = HydeNet:::mapEdges, 
                               x[["nodes"]], 
                               x[["parents"]],
                               MoreArgs = list(node_df = node_df)))
  
  edge_df <- DiagrammeR::create_edge_df(from = edge_table[, 2], 
                                        to = edge_table[, 1])
  
  if (!is.null(customEdges)) HydeNet::mergeCustomEdges(edge_df, customEdges)
  
  
  
  DiagrammeR::create_graph(nodes_df = node_df,
                           edges_df = edge_df,
                           attr_theme = NULL)
  
}


## ----------------------------------------

# code to demo. For some reason set_edge_attrs() isn't working right, so have to do it manually

map_to_viridis <- function(vec, bins=64, option="D"){

  binned <- cut(vec, bins)
  levels(binned) <- viridis::viridis(bins, option=option)
  
  return(as.character(binned))
}


map_to_brewer <- function(vec, bins=11, mid=NULL, option="RdYlBu"){
  
  Min <- min(vec)
  Max <- max(vec)
  if (is.null(mid)){
    breaks <- seq(Min,Max, length.out=bins)
  } else {
    breaks <- c(seq(Min,mid,length.out=bins/2), seq(mid,Max, length.out=bins/2)[-1]) 
  }
  
  binned <- cut(vec, breaks=breaks, include.lowest = TRUE)
  levels(binned) <- RColorBrewer::brewer.pal(bins, name=option)
  
  return(as.character(binned))
}

```


```{r}
z <- custom_plot.HydeNetwork(h)

c <- find_dag_coefs(map_dag, train)

coefs <- tidy_coefs(c)

coefs %>%
  filter(parameter!="phi",parameter!="w_leak") %>%
  rename(from = parameter) %>%
  mutate(from = gsub("w_","",from)) %>%
  select(to, from, value) %>%
  merge(z$nodes_df %>% rename(from = label) %>% select(id, from), by="from") %>%
  mutate(from = id) %>%
  select(-id) %>%
  merge(z$nodes_df %>% rename(to = label) %>% select(id, to), by="to") %>%
  mutate(to = id) %>%
  arrange(to,from) -> edge_df_mod

z$nodes_df <- z$nodes_df %>% mutate(label = recode_nodes(label))
z <- z %>% 
  set_node_attrs(node_attr = fontname, values="Helvetica") %>%
  set_node_attrs(node_attr = fillcolor, 
                 values = ifelse(z$nodes_df$id==13, "lightgrey","white")) %>%
  set_node_attrs(node_attr = fontsize, values = 10) %>%
  set_edge_attrs(edge_attr=color, values = map_to_brewer(edge_df_mod$value)) %>%
  set_edge_attrs(edge_attr=penwidth, values=1.5) %>%
  set_edge_attrs(edge_attr=arrowsize, values=1)

z$edges_df$color <- map_to_brewer(edge_df_mod$value, mid=0,option="RdBu")
render_graph(z)

```

## Color legend

```{r}
legend_plot <- tibble(values = edge_df_mod$value, colors = map_to_brewer(edge_df_mod$value,mid = 0)) %>%
  mutate(x = 1) %>%
  ggplot(aes(x=x, y=values, color=values)) +
  geom_point() +
  scale_color_distiller(palette="RdYlBu", direction=1) +
  labs(color="Weight")


# extract Legend 
g_legend <- function(a.gplot){ 
  tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
  legend <- tmp$grobs[[leg]] 
  return(legend)
  } 

legend <- g_legend(legend_plot)

# ggsave(plot = legend, filename = "../local/legend.png")
```


# Data prep

```{r tidy, include = F}
# load data
d_all <- read.csv("../data/study2_data.csv")[-1]

# reformat to match previous analyses (i.e., 2 rows per participant)
d_demo <- d_all %>% 
  select(workerId, condition, gender, age, ethnicity, education, job, income,
         political_party, political_beliefs, eligible_pretest, 
         is_parent_posttest, children_num_posttest, children_oldest_posttest, 
         children_youngest_posttest, plan_parent_posttest,
         starts_with("flushot_"), starts_with("vax_"), starts_with("attention_"),
         starts_with("comments"), starts_with("duration"))
d_pre <- d_all %>% 
  select(workerId, ends_with("_pretest")) %>%
  select(-c(eligible_pretest, starts_with("flushot_"), starts_with("vax_"), 
            starts_with("attention_"), starts_with("comments"), 
            starts_with("duration"))) %>%
  rename_all(funs(gsub("_pretest", "", .))) %>%
  mutate(phase = "pre")
d_post <- d_all %>% 
  select(workerId, ends_with("_posttest")) %>%
  select(-c(is_parent_posttest, children_num_posttest, children_oldest_posttest,
            children_youngest_posttest, plan_parent_posttest,
            starts_with("flushot_"), starts_with("vax_"), starts_with("attention_"),
            starts_with("comments"), starts_with("duration"))) %>%
  rename_all(funs(gsub("_posttest", "", .))) %>%
  mutate(phase = "post")

d <- bind_rows(d_pre, d_post) %>% 
  gather(question, response, -c(workerId, phase)) %>%
  mutate(phase = factor(phase,
                        levels = c("pre", "post")),
         reverse_cat = ifelse(grepl("_[1-9]r$", question), TRUE, FALSE),
         # NOTE: "response" has already been reverse coded!
         question = factor(question),
         scale = factor(gsub("_.*$", "", question),
                        levels = c("vaccIntent", "vaccDanger", "vaccEff", 
                                   "vaccStrain", "vaccTox", 
                                   "diseaseSevere", "diseaseRare", 
                                   "infantImmLimCap", "infantImmWeak", 
                                   "medSkept", "hb", "nat", 
                                   "overpar", "parentExpert"))) %>%
  full_join(d_demo) %>%
  mutate(condition = factor(condition, levels = c("noInterv", "diseaseRisk"))) %>%
  filter(!is.na(response), !is.na(workerId), !is.na(condition)) %>%
  distinct()

# how many left?
d %>% distinct(workerId, condition) %>% count(condition)
```

```{r scores, include = F}
# score all scales
d_scored <- d %>%
  select(workerId, condition, phase, scale, response,
         gender:duration_posttest) %>%
  group_by(workerId, condition, phase, scale) %>%
  mutate(response = as.numeric(response)) %>%
  summarise(mean = mean(response, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct()
```


It looks like there's a lot of overlap in the pre- and post-test distrubtions for all scales - though a few hints of subtle shifts (e.g., in `diseaseRare`, `vaccIntent`).

# Visual comparison of pre- vs. post-intervention

Let's compare participants' responses pre- vs. post-intervention on all scales. I'll plot both mean pre- and post-intervention scores, as well as mean difference scores (note separate axes):

```{r plot means}
d_means <- d_scored %>%
  distinct(workerId, condition, phase, scale, mean) %>%
  group_by(condition, phase, scale) %>%
  # summarise(Mean = mean(mean, na.rm = T),
  #           Lower = Mean - 2 * sd(mean, na.rm = T)/sqrt(n()),
  #           Upper = Mean + 2 * sd(mean, na.rm = T)/sqrt(n())) %>%
  do(data.frame(rbind(smean.cl.boot(.$mean)))) %>% # bootstrapped 95% CI
  ungroup() %>%
  distinct() %>%
  mutate(scale = factor(scale,
                        levels = c("vaccIntent", "vaccDanger", "vaccEff", 
                                   "vaccStrain", "vaccTox", 
                                   "diseaseSevere", "diseaseRare", 
                                   "infantImmLimCap", "infantImmWeak", 
                                   "medSkept", "hb", "nat", 
                                   "overpar", "parentExpert")),
         condition = factor(condition,
                            levels = c("diseaseRisk", "autismCorr", "noInterv")))
# 
# g_means <- ggplot(d_means,
#                   aes(x = phase, y = Mean,
#                       color = condition, group = condition)) +
#   facet_wrap(~ scale, ncol = 3) +
#   geom_path(position = position_dodge(width = 0.1)) +
#   geom_linerange(aes(ymin = Lower, ymax = Upper),
#                  position = position_dodge(width = 0.1)) +
#   geom_point(size = 3,
#              position = position_dodge(width = 0.1)) +
#   scale_y_continuous("mean score", 
#                      # limits = c(-3, 3),
#                      breaks = seq(-3, 3, 1)) +
#   scale_color_brewer(palette = "Set1", direction = -1) +
#   theme_bw() +
#   theme(legend.position = "bottom") +
#   labs(title = "mean scores by phase and condition",
#        subtitle = "error bars are bootstrapped 95% CIs")
# 
# g_means
```

```{r plot diffs}

recode_nodes2 <- function(x){
  recode(x,
         "diseaseRare" = "Disease\nRarity",
         "diseaseSevere" = "Disease\nSeverity",
         "hb" = "Holistic\nBalance",
         "infantImmLimCap" = "IIS:\nLimited\nCapacity",
         "infantImmWeak" = "IIS:\nWeakness",
         "medSkept" = "Medical\nSkepticism",
         "nat" = "Naturalism",
         "overpar" = "Parental\nProtect-\nivenness",
         "parentExpert" = "Parental\nExpertise",
         "vaccDanger" = "Vaccine\nDanger",
         "vaccEff" = "Vaccine\nEffect-\niveness",
         "vaccIntent" = "Vaccine\nIntentions",
         "vaccStrain" = "IIS:\nVaccines\nStrain",
         "vaccTox" = "Vaccines\nToxicity")}

boot_ci_upper <- function(x){
  Hmisc::smean.cl.boot(x)[3]
}

boot_ci_lower <- function(x){
  Hmisc::smean.cl.boot(x)[2]
}

# standard error function
std_err <- function(x) {
          sqrt(var(x[!is.na(x)]) / length(x[!is.na(x)]))
}


d_diffs <- d_scored %>%
  mutate(mean = rescale_beta(mean,-3,3)) %>%
  spread(phase, mean) %>%
  mutate(post_pre_diff = post - pre) %>%
  group_by(condition, scale) %>%
  summarise(
    Mean = mean(post_pre_diff),
    Upper95 = boot_ci_upper(post_pre_diff),
    Lower95 = boot_ci_lower(post_pre_diff),
    UpperSD = mean(post_pre_diff) + std_err(post_pre_diff),
    LowerSD = mean(post_pre_diff) - std_err(post_pre_diff),
    ) %>%
  # do(data.frame(rbind(smean.cl.boot(.$post_pre_diff)))) %>%
  ungroup() %>%
  mutate(scale = factor(scale,
                        levels = c("vaccIntent", "vaccDanger", "vaccEff", 
                                   "vaccStrain", "vaccTox", 
                                   "diseaseSevere", "diseaseRare", 
                                   "infantImmLimCap", "infantImmWeak", 
                                   "medSkept", "hb", "nat", 
                                   "overpar", "parentExpert")),
         condition = factor(condition,
                            levels = c("diseaseRisk", "autismCorr", "noInterv"),
                            labels = c("Disease Risk", "autismCorr", "No-intervention"))) %>%
  mutate(scale = recode_nodes2(scale))

(
g_diffs <- ggplot(d_diffs,
                  aes(x = reorder(scale, -Mean), y = Mean, 
                      color = condition, group = condition)) +
  # facet_wrap(~ scale, ncol = 3) +
  geom_hline(yintercept = 0, lty = 2, size = 0.5) +
  geom_linerange(aes(ymin = Lower95, ymax = Upper95), position = position_dodge(.25)) +
  geom_linerange(aes(ymin = LowerSD, ymax = UpperSD), 
                 position = position_dodge(.25), size=1.5) +
  geom_point(size = 3, position = position_dodge(.25)) +
  # scale_y_continuous("mean diff") + #, 
                     # limits = c(-3, 3), 
                     # breaks = seq(-3, 3, 1)) +
  # scale_color_brewer(palette = "Set1", direction = -1) +
  scale_color_manual(values=ibm_palette[c(3,1)]) + # this is a hack to make it match other fig
  theme_bw(base_size=14) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(size=8),
    panel.grid = element_blank()
        ) +
  labs(
    # title = "mean difference scores by scale and condition",
       # subtitle = "error bars are 95% bootstrapped CIs",
       x = "Belief",
       y = "Mean Change Score",
       color = "Condition") 
)

ggsave(plot = g_diffs, filename = "../local/s2_diffs.png", height=5, width=8.5)

```

```{r}
 # standard error function
stderr <- function(x) {
          sqrt(var(x[!is.na(x)]) / length(x[!is.na(x)]))
}

(
  vacc_intent_change_plot <- d_diffs %>%
  filter(scale=="Vaccine\nIntentions") %>%
  mutate(condition = factor(condition, levels = c("No-intervention", "Disease Risk"))) %>%
  ggplot(aes(x = condition, fill=condition, y = Mean, ymin = LowerSD, ymax=UpperSD)) +
    geom_bar(stat="identity") +
    geom_errorbar(width=.1) +
  theme_bw(base_size=14) +
  # scale_fill_brewer(palette = "Set1", direction = 1) +
  scale_fill_manual(values=ibm_palette[c(1,3)]) +
  geom_hline(yintercept = 0, linetype="dashed") +
  theme(panel.grid = element_blank(), legend.position = "none") +
  labs(
    x = "Condition",
    y = "Mean Change Score"
  )
)

# ggsave(plot = vacc_intent_change_plot, filename = "../local/s2_vacc_intent.png", height=4, width=5)
```


```{r plot means and diffs, fig.width = 3, fig.asp = 3}
multiplicand <- 6
multi_fun <- function(x, multi = multiplicand){return(x * multi)}
g_means +
  geom_segment(aes(x = 2.5, xend = 3.5, y = 0, yend = 0), 
               color = "black", lty = "dashed", size = 0.3) +
  geom_linerange(data = d_diffs %>% 
                   mutate_at(vars(Mean, Lower, Upper), funs(multi_fun)) %>%
                   mutate(phase = "diff"),
                 aes(x = phase, ymin = Lower, ymax = Upper),
                 position = position_dodge(width = 0.5)) +
  geom_point(data = d_diffs %>%
               mutate_at(vars(Mean, Lower, Upper), funs(multi_fun)) %>%
               mutate(phase = "diff"),
             aes(x = phase, y = Mean),
             position = position_dodge(width = 0.5),
             size = 2, shape = 17) +
  scale_x_discrete(limits = c("pre", "post", "diff")) +
  scale_y_continuous("mean score", breaks = seq(-3, 3, 1),
                     sec.axis = sec_axis(~./multiplicand, 
                                         name = "mean diff")) +
  scale_color_brewer(palette = "Set1", direction = -1) +
  theme(legend.position = "top", 
        panel.grid.minor.y = element_blank()) +
  labs(title = "means and mean difference scores by scale and condition",
       subtitle = "error bars are 95% bootstrapped CIs\nNOTE:use left y-axis for pre and post phases, right y-axis for difference scores")
```


# modeling

```{r}
# load in model components

map_dag <- readRDS("../local/map_dag_bn_theorybased.rds")
h <- readRDS("../local/map_dag_hydenet_theorybased.rds")
model_string <- readRDS("../local/map_dag_modelstring_theorybased.rds")
test_analyze <- readRDS("../local/s1_model_predictions.rds")
```


s1 model predictions ...

```{r}
# library(ggthemes)

summarize <- dplyr::summarise

recode_nodes <- function(x){
  recode(x,
         "diseaseRare" = "Disease Rarity",
         "diseaseSevere" = "Disease Severity",
         "hb" = "Holistic Balance",
         "infantImmLimCap" = "IIS: Limited\nCapacity",
         "infantImmWeak" = "IIS: Weakness",
         "medSkept" = "Medical\nSkepticism",
         "nat" = "Naturalism",
         "overpar" = "Parental\nProtectiveness",
         "parentExpert" = "Parental\nExpertise",
         "vaccDanger" = "Vaccine\nDanger",
         "vaccEff" = "Vaccine\nEffectiveness",
         "vaccIntent" = "Vaccination\nIntentions",
         "vaccStrain" = "IIS: Vaccines\nStrain",
         "vaccTox" = "Vaccines\nToxicity")}

predObsCor <- cor(test_analyze$value,test_analyze$predValue)

corrDF <- test_analyze %>%
  # mutate(varName = recode_nodes(varName)) %>%
  group_by(varName) %>%
  summarize(cor = cor(value,predValue)) %>%
  mutate(cor = format(round(cor,2),nsmall=2))

plt.valid <- test_analyze %>%
  mutate(varName = recode_nodes(varName)) %>%
  ggplot(aes(x=predValue, y=value)) + 
  geom_abline(slope=1, intercept=0, linetype="dashed", alpha=.33) +
  geom_point(shape=1, size=.5, color="darkturquoise") + 
  geom_text(data=(corrDF %>% mutate(varName = recode_nodes(varName))), 
            aes(label=paste("r =", cor)),
            x=-Inf, y=Inf, hjust=-0.12, vjust=1.4,
            size = 10*.352777778,
            color="grey25") +
  # geom_smooth(method="lm") +
  coord_fixed() + 
  facet_wrap(~varName, nrow=2) + 
  scale_x_continuous("Predicted values", limits = c(0, 1)) +
  scale_y_continuous("Observed values", limits = c(0, 1)) +
  theme_bw(base_size = 10) +
  theme(strip.background = element_rect(fill="grey90"), 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggsave(plot = plt.valid, filename = "../local/s1_predobs_plot.png", width=8.5, height=4)
```




# simulating hypothetical interventions

```{r}

# this is some code to genrate predictions of vacc intent change based on
# hypothetical interventions


source("../scripts/custom-structure-learning/cog-model-main.R", chdir = TRUE)

create_bnlearn_cog_model <- function(dag, data, evid_cpt = NULL, targetted_belief = NULL) {
  arcs_df <- bnlearn_to_df(dag)
  graph_list <- df_to_list(arcs_df)
  bagOfModels <- lapply(graph_list, function(x){fit_node_cpt(x, data)})
  model_string <- as.character(dag)

  if (!(is.null(evid_cpt))) {
    bagOfModels$evid <- evid_cpt
    model_string <- paste0(model_string,"[evid|", targetted_belief, "]")
  }
  model_network <- model2network(model_string)
  bnlearn_models <- lapply(bagOfModels, hyde_to_bn_cpt)
  predModel <- custom.fit(model_network, dist = bnlearn_models)

  return(predModel)
}


add_evid_node <- function(data, bnlearn_model, targetted_belief, evid_id = NULL) {
  
  if (!is.null(evid_id)) {
    evid <- paste0("evid",evid_id)
  } else {
    evid <- "evid"
  }
  
  evid_cpt <- make_evid_cpt(data, targetted_belief, evid)
  model_list <- lapply(bnlearn_model, function(x){x$prob})
  model_list[[evid]] <- hyde_to_bn_cpt(evid_cpt)
  
  model_string <- modelstring(bnlearn_model)
  model_string <- paste0(model_string,"[", evid,"|", targetted_belief, "]")
  
  model_network <- model2network(model_string)
  predModel <- custom.fit(model_network, dist = model_list)
  
  return(predModel)
}

add_evid_node_custom <- function(bnlearn_model, parents_string, evid_cpt) {

  model_list <- lapply(bnlearn_model, function(x){x$prob})
  model_list$evid <- evid_cpt

  model_string <- modelstring(bnlearn_model)
  model_string <- paste0(model_string,"[evid|", parents_string, "]")
  model_network <- model2network(model_string)
  predModel <- custom.fit(model_network, dist = model_list)

  return(predModel)
}

cogModel_predictions <- function(model){
  pred0 <- sapply(nodes, function(x){
  statement <- paste0("cpquery(model, event = (", x, " == 'Yes'), evidence=TRUE, n = 1e5)")
  eval(parse(text=statement))
  })
  
  pred1 <- sapply(nodes, function(x){
    statement <- paste0("cpquery(model, event = (", x, " == 'Yes'), evidence= (evid == 'Yes'), n = 1e5)")
    eval(parse(text=statement))
  })
  
  pred_changes <- pred1 - pred0
  
  pred_changes <- as.data.frame(pred_changes)
  
  pred_changes <- pred_changes %>%
    mutate(scale = nodes) %>%
    rename(Mean = pred_changes) %>%
    mutate(type = "predicted")
  
  return(pred_changes)
}

base_model <- create_bnlearn_cog_model(map_dag, train)

# source("../study2/load-study2-data.R", chdir = TRUE)


dag_nodes <- nodes(map_dag)

vaccIntent_pred_results <- data.frame(scale=dag_nodes, value = NA)

for (i in 1:length(dag_nodes)) {
  if (cor(d_bn[,"vaccIntent"], d_bn[,dag_nodes[i]]) >= 0) {
    evid_ratio <- 2
  } else {
    evid_ratio <- .5
  }
  evid_cpt <- hyde_to_bn_cpt(make_evid_cpt_custom(dag_nodes[i], evid_ratio))
  vaccIntent_predNet <- add_evid_node_custom(base_model, dag_nodes[i], evid_cpt)
  
  preds <- cogModel_predictions(vaccIntent_predNet) %>%
    filter(scale=="vaccIntent")
  
  vaccIntent_pred_results[i,"value"] <- preds[1,"Mean"]
  
}


## combine this with observed correlations from study 1

corrmat <- cor(d_bn)

interv_sim <- corrmat["vaccIntent",] %>%
  tibble(scale = names(.), value = ., type="correlation") %>%
  bind_rows(vaccIntent_pred_results %>% mutate(type="model_pred")) %>%
  spread(type,value)

interv_sim %>%
  ggplot(aes(x=abs(correlation), y = model_pred)) +
  geom_point()

(pred_change_plot <- interv_sim %>% 
  filter(scale!="vaccIntent") %>%
    mutate(scale = recode_nodes(scale)) %>%
  ggplot(aes(x=reorder(scale, model_pred), y = model_pred)) + 
  geom_bar(stat="identity", fill=ibm_palette[3], width=.5) + 
  coord_flip() +
  labs(x="Targeted belief", y = "Predicted change in intentions") +
  theme_bw(base_size=12) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(aspect.ratio = 1.5))
  

ggsave("../local/predicted_changes.png", pred_change_plot, height=5, width=5)
```


Compare predicted and observed changes ...

```{r}
set.seed(12345)

filter_dscored <- function(data, scale_name){
  
  data %>%
  filter(scale == scale_name) %>%
  mutate(mean = rescale_beta(mean, -3, 3)) %>%
  spread(phase, mean) %>% 
  mutate(condition = relevel(condition, ref="noInterv")) %>%
  mutate(evid = ifelse(condition=="noInterv",0,1))
}

 
# d <- d_scored %>%
#   filter(scale == "diseaseSevere") %>%
#   mutate(mean = rescale_beta(mean, -3, 3)) %>%
#   spread(phase, mean) %>% 
#   mutate(condition = relevel(condition, ref="noInterv")) %>%
#   mutate(evid = ifelse(condition=="noInterv",0,1))

predModel <- add_evid_node(filter_dscored(d_scored, "diseaseSevere"), base_model, "diseaseSevere")

pred0 <- sapply(nodes, function(x){
  statement <- paste0("cpquery(predModel, event = (", x, " == 'Yes'), evidence=TRUE, n = 5e5)")
  eval(parse(text=statement))
})

pred1 <- sapply(nodes, function(x){
  statement <- paste0("cpquery(predModel, event = (", x, " == 'Yes'), evidence= (evid == 'Yes'), n = 5e5)")
  eval(parse(text=statement))
})

pred_changes <- pred1 - pred0

pred_changes <- as.data.frame(pred_changes)

pred_changes <- pred_changes %>%
  mutate(scale = nodes) %>%
  rename(Mean = pred_changes) %>%
  mutate(type = "predicted")

```

```{r}


obs_changes <- d_scored %>%
  mutate(mean = rescale_beta(mean, -3, 3)) %>%
  spread(phase,mean) %>%
  mutate(changeScore = post-pre) %>%
  filter(condition == "diseaseRisk") %>%
  group_by(scale) %>%
  summarise(
    Mean = mean(changeScore),
    ul = mean(changeScore) + 1.96*sd(changeScore)/sqrt(n()), # replace with bootstrapping
    ll = mean(changeScore) - 1.96*sd(changeScore)/sqrt(n())
    ) %>%
  mutate(type = "observed")

obs_pred <- bind_rows(pred_changes, obs_changes) %>%
  spread(type, Mean) %>%
  group_by(scale) %>%
  summarize_all(mean, na.rm=TRUE)

cor(obs_pred$predicted, obs_pred$observed)

(obs_pred_plot <- obs_pred %>% # a bit of a hack
  ggplot(aes(x=predicted, y = observed, ymin = ll, ymax=ul)) +
  geom_abline(slope=1, intercept=0, linetype="dashed", alpha =.5) +
  geom_point(size=2) +
  geom_errorbar(alpha=.5, width=0) +
  coord_cartesian(xlim=c(-.06,.08), ylim=c(-.06,.08)) +
  labs(x="Predicted", y="Observed") +
  theme_bw(base_size=16) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(aspect.ratio = 1))

obs_pred %>%
  gather(type, Mean, observed, predicted) %>%
  ggplot(aes(y = reorder(scale, Mean), x = Mean, xmin = ll, xmax = ul, color=type)) +
  geom_point() +
  geom_errorbarh(height=0)


ggsave("../local/obs_pred_plot.png",obs_pred_plot, height=5, width=5)
```



# backslides stuff

## model comparison


```{r}
# compute test-retest reliability for each scale
test_retest_cor <- function(node){
    df <- d_scored %>%
    filter(condition == "noInterv", scale == node) %>%
    spread(phase, mean)
  return( cor(df$pre,df$post) )
}

test_retest <- tibble(node=as.character(nodes(map_dag))) %>%
  mutate(fit = map_dbl(node, test_retest_cor))


build_formula <- function(node, all_nodes){
  
  lhs_nodes <- all_nodes[all_nodes != node]
  
  f <- paste(node, "~ ")
  for (n in lhs_nodes){
    f <- paste0(f, n, " + ")
  }
  
  f <- substr(f,1,nchar(f)-3)
  
  return(f)
}

make_model <- function(node){
  betareg(as.formula(build_formula(node, nodes)), 
        data = train)
}

calc_oos_fit <- function(model, node){ # break this up

  p <- predict(model, test)
  
  cor(p, test[,node])
}

calc_change <- function(model,node){
  df <- d_scored %>%
    filter(condition=="diseaseRisk") %>%
    group_by(scale, phase) %>%
    summarize(mean = mean(mean)) %>%
    spread(phase, mean)
  
  df1 <- df %>%
    select(scale, pre) %>%
    spread(scale, pre)
  
  # df2 <- df %>%
  #   select(scale,post) %>%
  #   spread(scale, post)
  
  df1[2,] <- df1[1,]  # can swap to have all changing ...
  df1[2,"diseaseSevere"] <- df[6, "post"]
  
  p <- predict(model, df1)
  
  p[2] - p[1]
}

oos_fits <- tibble(node=as.character(nodes)) %>%
  mutate(model = map(node, make_model)) %>%
  mutate(fit = map2_dbl(model, node, calc_oos_fit)) %>%
  mutate(pred_change = map2_dbl(model, node, calc_change))
```

Full models do just as well at predicting relationships as the cognitive model does ...

```{r}
library(patchwork)

r_lower <- function(r,n){
  map2_dbl(r, n, function(r,n){psych::r.con(r,n)[1]})
}

r_upper <- function(r,n){
  map2_dbl(r, n, function(r,n){psych::r.con(r,n)[2]})
}

model_fits <- corrDF %>%
  rename(node = varName, model_fit = cor) %>%
  mutate(fit = as.numeric(model_fit)) %>%
  select(-model_fit) %>%
  mutate(model = "model_fit") %>%
  bind_rows(test_retest %>% mutate(model = "test_retest")) %>%
  bind_rows(oos_fits %>% mutate(model = "full_model") %>% select(-pred_change)) %>%
  # spread(model, fit) %>%
  # mutate(prop_var = model_fit^2/test_retest^2) %>%
  # gather(model, fit, model_fit, test_retest) %>%
  mutate(n = ifelse(model=="test_retest", 233, 226)) %>%
  mutate(ul = r_upper(fit,n), ll= r_lower(fit,n)) %>%
  mutate(node = recode_nodes2(node))

(
  test_v_retest_plot <- model_fits %>%
    # mutate(fit = fit^2, ul = ul^2, ll = ll^2)
  # filter(model!="full_fit") %>%
  # mutate(model = ifelse(model=="model_fit", "model", "test-retest")) %>%
  ggplot(aes(x=reorder(node, -fit), y = fit, color=model, ymin = ll, ymax =ul)) +
  # geom_errorbar(position = position_dodge(width=.25)) +
  geom_pointrange(size =.25, position = position_dodge(width=.25)) +
  ylim(0,1) +
  theme_bw(base_size = 12) +
  labs(x="Belief", y = "Correlation") +
    theme(
    legend.position = "bottom",
    axis.text.x = element_text(size=8),
    panel.grid = element_blank()
        )
  # theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=.75))
  )

ggsave(plot = test_v_retest_plot, filename = "../local/s1_model_test_v_retest_plot2.png", width=8.5, height=5)
# # (
#   prop_var_plot <- model_fits %>%
#     group_by(node) %>%
#     summarise(prop_var = mean(prop_var), fit = mean(fit)) %>%
#   ggplot(aes(x=reorder(node, fit), y = prop_var)) + 
#   geom_bar(stat="identity", fill="salmon", width=.5) +
#   theme_bw(base_size=12) +
#   labs(x = "Belief", y = "Prop. non-error\nvariance") +
#     theme(axis.title.y= element_blank(), axis.text.y = element_blank()) +
#   coord_flip()
# # )



# (model_valid_comp_plot <- (test_v_retest_plot + prop_var_plot) * theme(panel.grid = element_blank()))
# 
# ggsave(plot = model_valid_comp_plot, filename = "../local/s1_model_valid_comp_plot.png", width=8, height=5)

```

Predicting changes using full-model ensemble approach ... (predicts poorly, r = .34)

```{r}
full_models_pred_changes <- oos_fits %>%
  rename(scale = node, Mean=pred_change) %>%
  mutate(type = "predicted") %>%
  select(-model,-fit)

obs_pred_fm <- bind_rows(full_models_pred_changes, obs_changes) %>%
  spread(type, Mean) %>%
  group_by(scale) %>%
  summarize_all(mean, na.rm=TRUE)

cor(obs_pred_fm$predicted, obs_pred_fm$observed)

(obs_pred_fm_plot <- obs_pred_fm %>% # a bit of a hack
  ggplot(aes(x=predicted, y = observed, ymin = ll, ymax=ul)) +
  geom_abline(slope=1, intercept=0, linetype="dashed", alpha =.5) +
  geom_point(size=2) +
  geom_errorbar(alpha=.5, width=0) +
  coord_cartesian(xlim=c(-.06,.08), ylim=c(-.06,.08)) +
  # labs(title="full model ensemble") +
  labs(x="Predicted", y="Observed") +
  theme_bw(base_size=16) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  theme(aspect.ratio = 1))

ggsave(plot = obs_pred_fm_plot, filename = "../local/naive_model_change_pred.png", width=5, height=5)
```


## Score distributions

First, let's look at the distributions of scores for all scales, pre- and post-test:

```{r scores histo, fig.width = 7, fig.height = 2}
ggplot(d_scored, 
       aes(x = mean, fill = phase)) +
  # facet_wrap(~ scale, ncol = 5) +
  facet_grid(condition ~ scale) +
  geom_histogram(bins = 14, position = "identity", alpha = 0.6) +
  scale_x_continuous(breaks = seq(-3, 3, 1)) + 
  theme_bw() +
  labs(title = "distributions of scores by scale, condition, and phase (pre/post)")
```

